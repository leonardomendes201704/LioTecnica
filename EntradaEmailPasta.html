<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal RH • Liotécnica — Entrada (Email/Pasta)</title>

  <!-- Bootstrap 5 (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">

  <style>
    :root{
      --lt-primary:#0C3A64;
      --lt-brand:#105291;
      --lt-soft:#ADC8DC;
      --lt-bg:#F6F9FC;
      --lt-card:#FFFFFF;
      --lt-text:#0D1B2A;
      --lt-muted:rgba(13,27,42,.65);
      --lt-border:rgba(16,82,144,.18);
      --lt-shadow:0 10px 30px rgba(11,58,100,.10);
      --radius-xl:18px;
      --radius-lg:14px;
      --ui-scale:.75;
    }
    html,body{height:100%;}
    body{
      background:
        radial-gradient(1100px 480px at 15% 0%, rgba(173,200,220,.30), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(16,82,144,.16), transparent 55%),
        var(--lt-bg);
      color:var(--lt-text);
      zoom:var(--ui-scale);
    }
    .app-shell{min-height:100vh;display:grid;grid-template-columns:290px 1fr;}
    .sidebar{
      background:linear-gradient(180deg, rgba(11,58,100,1) 0%, rgba(16,82,144,1) 100%);
      color:rgba(255,255,255,.92);
      border-right:1px solid rgba(255,255,255,.12);
      position:sticky;top:0;height:100vh;overflow:hidden;
    }
    .sidebar-inner{height:100%;display:flex;flex-direction:column;}
    .brand{display:flex;align-items:center;gap:.75rem;padding:1rem 1rem .75rem;}
    .brand img{width:38px;height:38px;border-radius:10px;background:#fff;padding:6px;box-shadow:0 10px 22px rgba(0,0,0,.18);object-fit:contain;}
    .brand .title{line-height:1.05;}
    .brand .title strong{display:block;font-size:1.02rem;letter-spacing:.2px;}
    .brand .title span{display:block;font-size:.78rem;opacity:.85;}
    .sidebar .nav-section{padding:.35rem 1rem;font-size:.72rem;text-transform:uppercase;letter-spacing:.12em;opacity:.75;margin-top:.35rem;}
    .sidebar .nav-link{
      color:rgba(255,255,255,.88);
      border-radius:12px;
      padding:.60rem .80rem;
      display:flex;align-items:center;gap:.65rem;
      margin:.10rem .75rem;
      border:1px solid transparent;
    }
    .sidebar .nav-link:hover{background:rgba(255,255,255,.10);border-color:rgba(255,255,255,.12);color:#fff;}
    .sidebar .nav-link.active{background:rgba(255,255,255,.16);border-color:rgba(255,255,255,.22);color:#fff;}
    .sidebar-footer{margin-top:auto;padding:.9rem 1rem 1.1rem;border-top:1px solid rgba(255,255,255,.12);background:rgba(0,0,0,.06);}
    .sidebar-footer .pill{display:inline-flex;gap:.4rem;align-items:center;padding:.35rem .55rem;border-radius:999px;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);font-size:.78rem;}
    .main{display:flex;flex-direction:column;min-width:0;}
    .topbar{
      position:sticky;top:0;z-index:1020;
      background:rgba(246,249,252,.78);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--lt-border);
    }
    .topbar-inner{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:.85rem 1rem;}
    .card-soft{
      background:var(--lt-card);
      border:1px solid var(--lt-border);
      border-radius:var(--radius-xl);
      box-shadow:var(--lt-shadow);
    }
    .btn-brand{
      background:linear-gradient(90deg,var(--lt-brand),var(--lt-primary));
      border:none;color:#fff;border-radius:999px;padding:.55rem .9rem;
    }
    .btn-brand:hover{filter:brightness(1.02);color:#fff;}
    .btn-ghost{border-radius:999px;border:1px solid var(--lt-border);background:rgba(255,255,255,.65);}
    .badge-soft{
      border:1px solid rgba(16,82,144,.22);
      background:rgba(173,200,220,.25);
      color:var(--lt-primary);
      font-weight:700;
      border-radius:999px;
      padding:.35rem .55rem;
      white-space:nowrap;
    }
    .content{padding:1rem 1rem 0;flex:1 1 auto;min-width:0;}
    .page-title{display:flex;align-items:flex-end;justify-content:space-between;gap:1rem;margin-bottom:.9rem;}
    .page-title h4{margin:0;font-weight:800;letter-spacing:.2px;}
    .page-title .subtitle{color:var(--lt-muted);font-size:.92rem;margin-top:.15rem;}
    .mini-title{font-size:.78rem;text-transform:uppercase;letter-spacing:.10em;color:rgba(13,27,42,.55);margin:0;}
    .footer{padding:1rem;border-top:1px solid var(--lt-border);color:var(--lt-muted);font-size:.90rem;background:rgba(255,255,255,.35);}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;}
    .nowrap{white-space:nowrap;}
    .muted{color:var(--lt-muted);}

    /* Entrada UI */
    .grid2{display:grid;grid-template-columns: 420px 1fr;gap:1rem;min-width:0;}
    .panel{min-width:0;}
    .pill{
      display:inline-flex;align-items:center;gap:.4rem;
      padding:.30rem .55rem;border-radius:999px;
      border:1px solid rgba(16,82,144,.18);
      background:rgba(255,255,255,.65);
      font-size:.82rem;color:rgba(13,27,42,.78);
      white-space:nowrap;
    }
    .status-tag{
      border-radius:999px;padding:.28rem .55rem;font-weight:700;
      border:1px solid rgba(16,82,144,.18);
      background:rgba(173,200,220,.20);
      color:var(--lt-primary);
      display:inline-flex;align-items:center;gap:.35rem;white-space:nowrap;
    }
    .status-tag.ok{border-color:rgba(25,135,84,.25);background:rgba(25,135,84,.10);color:rgba(25,135,84,.95);}
    .status-tag.warn{border-color:rgba(255,193,7,.40);background:rgba(255,193,7,.16);color:rgba(120,88,0,.95);}
    .status-tag.bad{border-color:rgba(220,53,69,.30);background:rgba(220,53,69,.12);color:rgba(153,19,34,.95);}
    .row-item{
      border-radius:16px;
      border:1px solid rgba(16,82,144,.16);
      background: rgba(255,255,255,.85);
      padding:.7rem .75rem;
      cursor:pointer;
      transition: transform .08s ease, border-color .12s ease;
    }
    .row-item:hover{transform:translateY(-1px);border-color:rgba(16,82,144,.28);}
    .row-item.active{background:#fff;border-color:rgba(16,82,144,.42);box-shadow:0 10px 26px rgba(11,58,100,.10);}
    .avatar{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background:rgba(173,200,220,.28);
      border:1px solid rgba(16,82,144,.18);
      color:var(--lt-primary);
      font-weight:900;letter-spacing:.2px;
      flex:0 0 auto;
    }
    .empty{
      border:1px dashed rgba(16,82,144,.30);
      border-radius: var(--radius-xl);
      padding: 1.2rem;
      background: rgba(255,255,255,.55);
      color: rgba(13,27,42,.70);
    }
    .dropzone{
      border:1px dashed rgba(16,82,144,.40);
      border-radius:18px;
      padding:1rem;
      background:rgba(255,255,255,.60);
    }
    .dropzone.dragover{
      background:rgba(173,200,220,.25);
      border-color: rgba(16,82,144,.55);
    }
    .progress{height:10px;background:rgba(16,82,144,.10);border-radius:999px;}
    .progress-bar{background:linear-gradient(90deg,var(--lt-brand),var(--lt-primary));border-radius:999px;}
    .chip{
      display:inline-flex;align-items:center;gap:.4rem;
      border-radius:999px;
      padding:.28rem .55rem;
      border:1px solid rgba(16,82,144,.18);
      background:rgba(255,255,255,.70);
      font-size:.80rem;
      color:rgba(13,27,42,.78);
      white-space:nowrap;
    }

    @media (max-width: 991.98px){
      .app-shell{grid-template-columns:1fr;}
      .sidebar{display:none;}
      .grid2{grid-template-columns:1fr;}
      .content{padding:.9rem .9rem 0;}
    }

    .toast{
      border-radius:14px;
      border:1px solid rgba(16,82,144,.18);
      box-shadow:var(--lt-shadow);
    }
  </style>
</head>

<body>
  <!-- MOBILE SIDEBAR OFFCANVAS -->
  <div class="offcanvas offcanvas-start" tabindex="-1" id="offcanvasSidebar">
    <div class="offcanvas-header border-bottom">
      <div class="d-flex align-items-center gap-2">
        <img id="logoMobile" alt="Liotécnica" style="width:34px;height:34px;border-radius:10px;background:#fff;padding:6px;object-fit:contain;">
        <div class="lh-1">
          <div class="fw-bold" style="color:var(--lt-primary)">Portal RH</div>
          <small class="text-muted">Entrada (Email/Pasta)</small>
        </div>
      </div>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
      <div class="p-2">
        <div class="small text-uppercase text-muted px-2 mt-2">Navegação</div>
        <div class="nav flex-column">
          <a class="nav-link rounded-3 px-3 py-2" href="#"><i class="bi bi-speedometer2 me-2"></i>Dashboard</a>
          <a class="nav-link rounded-3 px-3 py-2" href="#"><i class="bi bi-briefcase me-2"></i>Vagas</a>
          <a class="nav-link rounded-3 px-3 py-2" href="#"><i class="bi bi-people me-2"></i>Candidatos</a>
          <a class="nav-link rounded-3 px-3 py-2" href="#"><i class="bi bi-funnel me-2"></i>Triagem</a>
          <a class="nav-link rounded-3 px-3 py-2" href="#"><i class="bi bi-stars me-2"></i>Matching</a>
          <a class="nav-link rounded-3 px-3 py-2 fw-semibold" href="#"><i class="bi bi-inbox me-2"></i>Entrada (Email/Pasta)</a>
          <a class="nav-link rounded-3 px-3 py-2" href="#"><i class="bi bi-gear me-2"></i>Configurações</a>
        </div>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div class="position-fixed bottom-0 end-0 p-3" style="z-index:1100;">
    <div id="appToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header">
        <i class="bi bi-bell me-2" style="color:var(--lt-brand)"></i>
        <strong class="me-auto">Portal RH</strong>
        <small class="text-muted" id="toastWhen">agora</small>
        <button type="button" class="btn-close ms-2 mb-1" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body" id="toastMsg">—</div>
    </div>
  </div>

  <div class="app-shell">
    <!-- DESKTOP SIDEBAR -->
    <aside class="sidebar d-none d-lg-block">
      <div class="sidebar-inner">
        <div class="brand">
          <img id="logoDesktop" alt="Liotécnica">
          <div class="title">
            <strong>Portal RH</strong>
            <span>Entrada (Email/Pasta)</span>
          </div>
        </div>

        <div class="nav-section">Operação</div>
        <nav class="nav flex-column">
          <a class="nav-link" href="#"><i class="bi bi-speedometer2"></i>Dashboard</a>
          <a class="nav-link" href="#"><i class="bi bi-briefcase"></i>Vagas</a>
          <a class="nav-link" href="#"><i class="bi bi-people"></i>Candidatos</a>
          <a class="nav-link" href="#"><i class="bi bi-funnel"></i>Triagem</a>
          <a class="nav-link" href="#"><i class="bi bi-stars"></i>Matching</a>
          <a class="nav-link active" href="#"><i class="bi bi-inbox"></i>Entrada (Email/Pasta)</a>
        </nav>

        <div class="nav-section mt-2">Gestão</div>
        <nav class="nav flex-column">
          <a class="nav-link" href="#"><i class="bi bi-graph-up"></i>Relatórios</a>
          <a class="nav-link" href="#"><i class="bi bi-person-gear"></i>Usuários & Perfis</a>
          <a class="nav-link" href="#"><i class="bi bi-gear"></i>Configurações</a>
        </nav>

        <div class="sidebar-footer">
          <div class="d-flex align-items-center justify-content-between gap-2">
            <div class="small" style="opacity:.92;">
              <div class="fw-semibold">Ambiente</div>
              <div class="opacity-75">DEV • Postgres</div>
            </div>
            <span class="pill"><i class="bi bi-shield-check"></i>LGPD</span>
          </div>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">
      <!-- TOPBAR -->
      <header class="topbar">
        <div class="topbar-inner">
          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-ghost d-lg-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasSidebar">
              <i class="bi bi-list"></i>
            </button>
            <div class="d-none d-md-block">
              <div class="fw-bold" style="color:var(--lt-primary); line-height:1.05;">Liotécnica • Portal RH</div>
              <small class="text-muted">Tela: Entrada (captura de currículos)</small>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-ghost" type="button" id="btnSeedReset" title="Restaurar demo">
              <i class="bi bi-arrow-counterclockwise"></i><span class="d-none d-sm-inline ms-1">Reset demo</span>
            </button>

            <button class="btn btn-ghost" type="button" id="btnExport" title="Exportar (JSON)">
              <i class="bi bi-download"></i><span class="d-none d-sm-inline ms-1">Exportar</span>
            </button>

            <button class="btn btn-ghost" type="button" id="btnImport" title="Importar (JSON)">
              <i class="bi bi-upload"></i><span class="d-none d-sm-inline ms-1">Importar</span>
            </button>

            <button class="btn btn-brand" type="button" id="btnRunSim">
              <i class="bi bi-play-circle"></i><span class="d-none d-sm-inline ms-1">Simular coleta</span>
            </button>

            <div class="dropdown">
              <button class="btn btn-ghost dropdown-toggle" data-bs-toggle="dropdown">
                <i class="bi bi-person-circle me-1"></i><span class="d-none d-sm-inline">RH</span>
              </button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#"><i class="bi bi-person-gear me-2"></i>Meu perfil</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-bell me-2"></i>Notificações</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="#"><i class="bi bi-box-arrow-right me-2"></i>Sair</a></li>
              </ul>
            </div>
          </div>
        </div>
      </header>

      <!-- CONTENT -->
      <section class="content">
        <div class="page-title">
          <div>
            <h4>Entrada (Email / Pasta)</h4>
            <div class="subtitle">Central de ingestão: e-mails, pastas monitoradas e upload manual — tudo cai na fila de triagem.</div>
          </div>
          <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
            <span class="badge-soft"><i class="bi bi-clock me-1"></i><span id="nowLabel">—</span></span>
            <span class="badge-soft"><i class="bi bi-hdd me-1"></i>localStorage</span>
          </div>
        </div>

        <!-- KPIs -->
        <div class="row g-2 mb-3">
          <div class="col-6 col-lg-3">
            <div class="card-soft p-3">
              <div class="mini-title mb-1">Fila de Entrada</div>
              <div class="d-flex align-items-end justify-content-between">
                <div class="fw-bold" style="font-size:1.6rem;color:var(--lt-primary);" id="kpiQueue">0</div>
                <span class="pill"><i class="bi bi-inbox"></i>itens</span>
              </div>
              <div class="text-muted small mt-1">Arquivos/e-mails aguardando processamento.</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="card-soft p-3">
              <div class="mini-title mb-1">Processados hoje</div>
              <div class="d-flex align-items-end justify-content-between">
                <div class="fw-bold" style="font-size:1.6rem;color:var(--lt-primary);" id="kpiDone">0</div>
                <span class="pill"><i class="bi bi-check2-circle"></i>ok</span>
              </div>
              <div class="text-muted small mt-1">Ingestão completa com texto extraído.</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="card-soft p-3">
              <div class="mini-title mb-1">Falhas</div>
              <div class="d-flex align-items-end justify-content-between">
                <div class="fw-bold" style="font-size:1.6rem;color:rgba(153,19,34,.95);" id="kpiFail">0</div>
                <span class="pill"><i class="bi bi-exclamation-triangle"></i>atenção</span>
              </div>
              <div class="text-muted small mt-1">PDF corrompido, senha, anexos vazios, etc.</div>
            </div>
          </div>
          <div class="col-6 col-lg-3">
            <div class="card-soft p-3">
              <div class="mini-title mb-1">Integrações</div>
              <div class="d-flex align-items-end justify-content-between">
                <div class="fw-bold" style="font-size:1.6rem;color:var(--lt-primary);" id="kpiConnect">2</div>
                <span class="pill"><i class="bi bi-plug"></i>ativas</span>
              </div>
              <div class="text-muted small mt-1">Email IMAP + Pasta (watcher).</div>
            </div>
          </div>
        </div>

        <div class="grid2">
          <!-- LEFT: Queue -->
          <div class="panel">
            <div class="card-soft p-3 mb-3">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
                <div>
                  <div class="fw-bold">Fila de entrada</div>
                  <div class="text-muted small">Selecione um item para ver detalhes e executar ações.</div>
                </div>
                <div class="d-flex gap-2 flex-wrap justify-content-end">
                  <div class="input-group" style="min-width: 240px;">
                    <span class="input-group-text" style="border-color:var(--lt-border); background: rgba(255,255,255,.65);">
                      <i class="bi bi-search"></i>
                    </span>
                    <input class="form-control" id="fSearch" placeholder="Remetente, assunto, arquivo..." style="border-color:var(--lt-border);">
                  </div>
                  <select class="form-select" id="fOrigem" style="min-width: 180px; border-color:var(--lt-border);">
                    <option value="all">Origem: todas</option>
                    <option value="email">Email</option>
                    <option value="pasta">Pasta</option>
                    <option value="upload">Upload</option>
                  </select>
                  <select class="form-select" id="fStatus" style="min-width: 180px; border-color:var(--lt-border);">
                    <option value="all">Status: todos</option>
                    <option value="novo">Novo</option>
                    <option value="processando">Processando</option>
                    <option value="processado">Processado</option>
                    <option value="falha">Falha</option>
                    <option value="descartado">Descartado</option>
                  </select>
                </div>
              </div>

              <hr class="my-3" style="border-color: rgba(16,82,144,.14);">

              <div class="d-grid gap-2" id="queueList"></div>
              <div class="text-muted small mt-2" id="queueHint"></div>
            </div>

            <!-- Upload / Dropzone -->
            <div class="card-soft p-3">
              <div class="d-flex align-items-start justify-content-between gap-2">
                <div>
                  <div class="fw-bold">Upload manual (MVP)</div>
                  <div class="text-muted small">Arraste PDFs/DOCs aqui (demo salva apenas o nome do arquivo).</div>
                </div>
                <button class="btn btn-ghost btn-sm" id="btnAddUpload">
                  <i class="bi bi-paperclip me-1"></i>Selecionar arquivo
                </button>
              </div>

              <div class="dropzone mt-3" id="dropzone">
                <div class="d-flex align-items-start gap-2">
                  <i class="bi bi-cloud-arrow-up mt-1"></i>
                  <div class="flex-grow-1">
                    <div class="fw-semibold">Solte seus arquivos aqui</div>
                    <div class="text-muted small">Tipos comuns: .pdf, .doc, .docx</div>
                    <div class="d-flex flex-wrap gap-2 mt-2">
                      <span class="chip"><i class="bi bi-file-earmark-pdf"></i>PDF</span>
                      <span class="chip"><i class="bi bi-file-earmark-word"></i>Word</span>
                      <span class="chip"><i class="bi bi-file-earmark-text"></i>TXT</span>
                      <span class="chip"><i class="bi bi-shield-check"></i>LGPD</span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="text-muted small mt-2">
                <i class="bi bi-info-circle me-1"></i>
                No produto real: upload → armazenamento (S3/FS) → fila → extração de texto (PDF/Word) → candidato/triagem.
              </div>
            </div>
          </div>

          <!-- RIGHT: Details -->
          <div class="panel" id="detailHost">
            <div class="empty">
              <div class="d-flex align-items-start gap-2">
                <i class="bi bi-info-circle mt-1"></i>
                <div>
                  <div class="fw-bold">Selecione um item da fila</div>
                  <div class="small mt-1">Aqui você verá metadados, anexos e ações (processar, reprocessar, criar candidato, etc.).</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div style="height:14px;"></div>
      </section>

      <!-- FOOTER -->
      <footer class="footer">
        <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
          <div>© <span id="year"></span> Liotécnica • Portal RH (MVP)</div>
          <div class="d-flex align-items-center gap-3">
            <span><i class="bi bi-inbox me-1"></i>Entrada</span>
            <span><i class="bi bi-funnel me-1"></i>Triagem</span>
            <span><i class="bi bi-shield-check me-1"></i>LGPD</span>
          </div>
        </div>
      </footer>
    </main>
  </div>

  <!-- Hidden file input -->
  <input type="file" id="filePicker" accept=".pdf,.doc,.docx,.txt" multiple style="display:none;">

  <!-- Bootstrap JS (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ========= Logo (Data URI placeholder)
    const LOGO_DATA_URI = "data:image/webp;base64,UklGRngUAABXRUJQVlA4IGwUAAAQYwCdASpbAVsBPlEokUajoqGhIpNoyHAK7AQYJjYQmG9Dtu/6p6QZ4lQd6lPde+Jk3i3kG2EoP+QW0c0h8Oe3jW2C5zE0o9jzZ1x2fX9cZlX0d7rW8r0vQ9p3d2nJ1bqzQfQZxVwTt7mJvU8j1GqF4oJc8Qb+gq+oQyHcQyYc2b9u2fYf0Rj9x9hRZp2Y2xK0yVQ8Hj4p6w8B1K2cKk2mY9m2r8kz3a4m7xG4xg9m5VjzP3E4RjQH8fYkC4mB8g0vR3c5h1D0yE8Qzv7t7gQj0Z9yKk3cWZgVnq3l1kq6rE8oWc4z6oZk8k0b1o9m8p2m+QJ3nJm6GgA=";

    // ========= Helpers
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const clamp = (n,min,max) => Math.max(min, Math.min(max,n));
    function uid(){ return (crypto && crypto.randomUUID) ? crypto.randomUUID() : ("id-"+Math.random().toString(16).slice(2)+"-"+Date.now().toString(16)); }
    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"quot;")
        .replaceAll("'","&#039;");
    }
    function initials(name){
      const p = (name||"").trim().split(/\s+/).filter(Boolean);
      if(!p.length) return "—";
      const a = p[0][0]||"";
      const b = p.length>1 ? (p[p.length-1][0]||"") : "";
      return (a+b).toUpperCase();
    }
    function fmtDate(iso){
      if(!iso) return "—";
      const d = new Date(iso);
      return d.toLocaleString("pt-BR", { day:"2-digit", month:"2-digit", year:"numeric", hour:"2-digit", minute:"2-digit" });
    }
    function toast(msg){
      $("#toastMsg").textContent = msg;
      $("#toastWhen").textContent = "agora";
      bootstrap.Toast.getOrCreateInstance($("#appToast"), { delay: 2400 }).show();
    }

    // ========= Storage keys (compatível com telas anteriores)
    const VAGAS_KEY = "lt_rh_vagas_v1";
    const CANDS_KEY = "lt_rh_candidatos_v1";
    const INBOX_KEY = "lt_rh_inbox_v1";

    const state = {
      vagas: [],
      candidatos: [],
      inbox: [],
      selectedId: null,
      filters: { q:"", origem:"all", status:"all" }
    };

    function loadJson(key, fallback){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return fallback;
        return JSON.parse(raw);
      }catch{ return fallback; }
    }
    function saveInbox(){
      localStorage.setItem(INBOX_KEY, JSON.stringify({ inbox: state.inbox, selectedId: state.selectedId, savedAt: new Date().toISOString() }));
    }

    // ========= Seed (se vazio)
    function seedIfEmpty(){
      // Vagas
      const vagasRaw = loadJson(VAGAS_KEY, null);
      if(!vagasRaw || !Array.isArray(vagasRaw.vagas) || !vagasRaw.vagas.length){
        const vaga = {
          id: uid(),
          codigo: "VAG-001",
          titulo: "Analista de Dados",
          descricao: "Análise de indicadores, dashboards e apoio ao RH/gestão.",
          threshold: 65,
          requisitos: [
            { id: uid(), termo: "excel", peso: 5, obrigatorio: true, sinonimos: ["planilhas", "vlookup", "tabela dinamica"] },
            { id: uid(), termo: "power bi", peso: 4, obrigatorio: false, sinonimos: ["pbi", "powerbi"] },
            { id: uid(), termo: "sql", peso: 4, obrigatorio: false, sinonimos: ["postgres", "query"] },
            { id: uid(), termo: "indicadores", peso: 3, obrigatorio: false, sinonimos: ["kpi", "dashboards", "relatorios"] }
          ],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        localStorage.setItem(VAGAS_KEY, JSON.stringify({ vagas: [vaga] }));
      }

      // Candidatos (se não existir)
      const candRaw = loadJson(CANDS_KEY, null);
      if(!candRaw || !Array.isArray(candRaw.candidatos)){
        localStorage.setItem(CANDS_KEY, JSON.stringify({ candidatos: [], selectedId: null }));
      }

      // Inbox
      const inboxRaw = loadJson(INBOX_KEY, null);
      if(!inboxRaw || !Array.isArray(inboxRaw.inbox) || !inboxRaw.inbox.length){
        const vagas = loadJson(VAGAS_KEY, { vagas: [] }).vagas || [];
        const vagaId = vagas[0]?.id || null;

        const now = Date.now();
        const seed = [
          {
            id: uid(),
            origem: "email",
            status: "novo",
            recebidoEm: new Date(now - 1000*60*30).toISOString(),
            remetente: "mariana.souza@email.com",
            assunto: "Currículo • Analista de Dados",
            destinatario: "rh@liotecnica.com.br",
            vagaId,
            anexos: [
              { nome: "Mariana_Souza_CV.pdf", tipo: "pdf", tamanhoKB: 284, hash: "demo-1" }
            ],
            processamento: { pct: 0, etapa: "Aguardando", log: [], tentativas: 0, ultimoErro: null },
            previewText: "Experiência com excel avançado, dashboards e power bi..."
          },
          {
            id: uid(),
            origem: "pasta",
            status: "processando",
            recebidoEm: new Date(now - 1000*60*12).toISOString(),
            remetente: "watcher@server",
            assunto: "Novo arquivo em pasta monitorada",
            destinatario: "FS: \\\\RH\\Curriculos\\Entrada",
            vagaId,
            anexos: [
              { nome: "Ana_Ribeiro.docx", tipo: "docx", tamanhoKB: 512, hash: "demo-2" }
            ],
            processamento: { pct: 55, etapa: "Extraindo texto", log: ["Arquivo detectado", "Upload ok", "Extraindo texto..."], tentativas: 1, ultimoErro: null },
            previewText: "PowerBI, SQL, modelagem dimensional e analytics..."
          },
          {
            id: uid(),
            origem: "email",
            status: "falha",
            recebidoEm: new Date(now - 1000*60*90).toISOString(),
            remetente: "carlos.h@email.com",
            assunto: "CV atualizado (PDF protegido)",
            destinatario: "rh@liotecnica.com.br",
            vagaId,
            anexos: [
              { nome: "CarlosH_CV.pdf", tipo: "pdf", tamanhoKB: 190, hash: "demo-3" }
            ],
            processamento: { pct: 100, etapa: "Falha", log: ["Anexo encontrado", "Tentativa de leitura", "PDF com senha"], tentativas: 2, ultimoErro: "PDF protegido por senha" },
            previewText: ""
          }
        ];

        localStorage.setItem(INBOX_KEY, JSON.stringify({ inbox: seed, selectedId: seed[0].id, savedAt: new Date().toISOString() }));
      }
    }

    function loadAll(){
      state.vagas = (loadJson(VAGAS_KEY, { vagas: [] }).vagas || []);
      const c = loadJson(CANDS_KEY, { candidatos: [], selectedId: null });
      state.candidatos = c.candidatos || [];
      const i = loadJson(INBOX_KEY, { inbox: [], selectedId: null });
      state.inbox = i.inbox || [];
      state.selectedId = i.selectedId || state.inbox[0]?.id || null;
    }

    function findVaga(id){ return state.vagas.find(v => v.id === id) || null; }
    function findInbox(id){ return state.inbox.find(x => x.id === id) || null; }

    function statusTag(st){
      const map = {
        novo:  { cls:"", icon:"dot", label:"Novo" },
        processando:{ cls:"warn", icon:"arrow-repeat", label:"Processando" },
        processado:{ cls:"ok", icon:"check2-circle", label:"Processado" },
        falha:{ cls:"bad", icon:"exclamation-triangle", label:"Falha" },
        descartado:{ cls:"bad", icon:"trash3", label:"Descartado" }
      };
      const it = map[st] || { cls:"", icon:"dot", label: (st||"—") };
      return `<span class="status-tag ${it.cls}"><i class="bi bi-${it.icon}"></i>${it.label}</span>`;
    }
    function origemPill(o){
      const map = {
        email: { icon:"envelope", label:"Email" },
        pasta: { icon:"folder2-open", label:"Pasta" },
        upload: { icon:"cloud-arrow-up", label:"Upload" }
      };
      const it = map[o] || { icon:"question-circle", label:o||"—" };
      return `<span class="pill"><i class="bi bi-${it.icon}"></i>${it.label}</span>`;
    }
    function attachmentPill(a){
      const icon = a.tipo === "pdf" ? "file-earmark-pdf" :
                   (a.tipo === "doc" || a.tipo === "docx" ? "file-earmark-word" : "file-earmark");
      return `<span class="chip"><i class="bi bi-${icon}"></i>${escapeHtml(a.nome)} <span class="mono muted">(${escapeHtml(a.tamanhoKB)}KB)</span></span>`;
    }

    // ========= Filters
    function applyFilters(list){
      const q = (state.filters.q||"").trim().toLowerCase();
      const o = state.filters.origem;
      const s = state.filters.status;

      return list.filter(x => {
        if(o !== "all" && x.origem !== o) return false;
        if(s !== "all" && x.status !== s) return false;
        if(!q) return true;

        const vaga = findVaga(x.vagaId);
        const blob = [
          x.remetente, x.assunto, x.destinatario,
          vaga?.titulo, vaga?.codigo,
          ...(x.anexos||[]).map(a => a.nome)
        ].join(" ").toLowerCase();

        return blob.includes(q);
      });
    }

    // ========= Render
    function renderAll(){
      renderKPIs();
      renderList();
      renderDetail(state.selectedId ? findInbox(state.selectedId) : null);
    }

    function renderKPIs(){
      const today = new Date();
      const isSameDay = (iso) => {
        const d = new Date(iso);
        return d.getFullYear() === today.getFullYear() && d.getMonth() === today.getMonth() && d.getDate() === today.getDate();
      };

      const queue = state.inbox.filter(x => ["novo","processando"].includes(x.status)).length;
      const done = state.inbox.filter(x => x.status === "processado" && isSameDay(x.recebidoEm)).length;
      const fail = state.inbox.filter(x => x.status === "falha").length;

      $("#kpiQueue").textContent = queue;
      $("#kpiDone").textContent = done;
      $("#kpiFail").textContent = fail;
    }

    function renderList(){
      const list = applyFilters(state.inbox)
        .sort((a,b)=> new Date(b.recebidoEm||0) - new Date(a.recebidoEm||0));

      $("#queueHint").textContent = list.length ? "" : "Nenhum item encontrado com os filtros atuais.";
      $("#queueList").innerHTML = list.map(x => renderRow(x)).join("") || `<div class="text-muted small">—</div>`;

      $$(".row-item").forEach(el => {
        if(el.dataset.id === state.selectedId) el.classList.add("active");
        el.addEventListener("click", () => {
          state.selectedId = el.dataset.id;
          saveInbox();
          renderList();
          renderDetail(findInbox(state.selectedId));
        });
      });
    }

    function renderRow(x){
      const vaga = findVaga(x.vagaId);
      const anexo = x.anexos?.[0];
      const icon = x.origem === "email" ? "envelope" : (x.origem === "pasta" ? "folder2-open" : "cloud-arrow-up");

      const pct = clamp(parseInt(x.processamento?.pct||0,10)||0,0,100);
      const bar = (x.status === "processando")
        ? `<div class="progress mt-2"><div class="progress-bar" style="width:${pct}%"></div></div>`
        : ``;

      const sub = vaga ? `${vaga.titulo} (${vaga.codigo||"—"})` : "Vaga: não definida";

      return `
        <div class="row-item" data-id="${x.id}">
          <div class="d-flex align-items-start justify-content-between gap-2">
            <div class="d-flex align-items-center gap-2">
              <div class="avatar"><i class="bi bi-${icon}"></i></div>
              <div>
                <div class="fw-bold">${escapeHtml(x.assunto || (anexo?.nome || "—"))}</div>
                <div class="text-muted small">${escapeHtml(x.remetente || "—")} • ${escapeHtml(fmtDate(x.recebidoEm))}</div>
              </div>
            </div>
            <div class="text-end">
              ${statusTag(x.status)}
              <div class="text-muted small mt-1">${escapeHtml(sub)}</div>
            </div>
          </div>
          ${bar}
        </div>
      `;
    }

    function renderDetail(x){
      if(!x){
        $("#detailHost").innerHTML = `
          <div class="empty">
            <div class="d-flex align-items-start gap-2">
              <i class="bi bi-info-circle mt-1"></i>
              <div>
                <div class="fw-bold">Selecione um item da fila</div>
                <div class="small mt-1">Você verá metadados, anexos e ações.</div>
              </div>
            </div>
          </div>`;
        return;
      }

      const vaga = findVaga(x.vagaId);
      const pct = clamp(parseInt(x.processamento?.pct||0,10)||0,0,100);

      const attachments = (x.anexos||[]).length
        ? (x.anexos||[]).map(a => attachmentPill(a)).join(" ")
        : `<span class="text-muted small">Sem anexos</span>`;

      const log = (x.processamento?.log||[]);
      const logHtml = log.length
        ? `<ul class="mb-0 small">${log.map(l => `<li>${escapeHtml(l)}</li>`).join("")}</ul>`
        : `<div class="text-muted small">Sem logs ainda.</div>`;

      const errorBox = x.processamento?.ultimoErro
        ? `<div class="alert alert-danger mt-3 mb-0" style="border-radius:14px;">
             <div class="d-flex align-items-start gap-2">
               <i class="bi bi-exclamation-triangle mt-1"></i>
               <div>
                 <div class="fw-semibold">Erro</div>
                 <div class="small">${escapeHtml(x.processamento.ultimoErro)}</div>
               </div>
             </div>
           </div>`
        : "";

      const actions = `
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-brand btn-sm" id="btnProcess">
            <i class="bi bi-cpu me-1"></i>${x.status === "processando" ? "Continuar" : "Processar"}
          </button>
          <button class="btn btn-ghost btn-sm" id="btnReprocess">
            <i class="bi bi-arrow-repeat me-1"></i>Reprocessar
          </button>
          <button class="btn btn-ghost btn-sm" id="btnCreateCandidate">
            <i class="bi bi-person-plus me-1"></i>Criar candidato
          </button>
          <button class="btn btn-ghost btn-sm" id="btnDiscard">
            <i class="bi bi-trash3 me-1"></i>Descartar
          </button>
        </div>
      `;

      $("#detailHost").innerHTML = `
        <div class="card-soft p-3">
          <div class="d-flex flex-wrap align-items-start justify-content-between gap-2 mb-2">
            <div class="d-flex align-items-center gap-2">
              <div class="avatar" style="width:52px;height:52px;border-radius:16px;">
                <i class="bi bi-inbox"></i>
              </div>
              <div>
                <div class="fw-bold" style="font-size:1.05rem;">${escapeHtml(x.assunto || "—")}</div>
                <div class="text-muted small">${escapeHtml(x.remetente || "—")} • ${escapeHtml(fmtDate(x.recebidoEm))}</div>
                <div class="text-muted small">Destino: ${escapeHtml(x.destinatario || "—")}</div>
              </div>
            </div>
            <div class="text-end">
              ${statusTag(x.status)}
              <div class="text-muted small mt-1">Origem: ${origemPill(x.origem)}</div>
            </div>
          </div>

          <div class="d-flex flex-wrap gap-2 mb-3">
            <span class="pill"><i class="bi bi-briefcase"></i>${escapeHtml(vaga?.titulo || "Vaga não definida")}</span>
            <span class="pill mono">${escapeHtml(vaga?.codigo || "—")}</span>
            <span class="pill"><i class="bi bi-paperclip"></i>Anexos: <strong class="ms-1">${(x.anexos||[]).length}</strong></span>
            <span class="pill"><i class="bi bi-arrow-counterclockwise"></i>Tentativas: <strong class="ms-1">${escapeHtml(x.processamento?.tentativas ?? 0)}</strong></span>
          </div>

          <div class="row g-2">
            <div class="col-12 col-lg-6">
              <div class="fw-bold mb-2">Anexos</div>
              <div>${attachments}</div>

              <div class="mt-3">
                <div class="fw-bold">Preview (texto extraído)</div>
                <div class="text-muted small">No MVP real, vem do parser de PDF/Word.</div>
                <textarea class="form-control mt-2" rows="6" id="previewText" style="border-color:var(--lt-border);" placeholder="(vazio)">${escapeHtml(x.previewText || "")}</textarea>
                <div class="d-flex flex-wrap gap-2 mt-2">
                  <button class="btn btn-ghost btn-sm" id="btnSavePreview">
                    <i class="bi bi-save me-1"></i>Salvar preview
                  </button>
                  <button class="btn btn-ghost btn-sm" id="btnAutoAssign">
                    <i class="bi bi-diagram-3 me-1"></i>Auto-atribuir vaga (demo)
                  </button>
                </div>
              </div>

              ${errorBox}
            </div>

            <div class="col-12 col-lg-6">
              <div class="fw-bold mb-2">Processamento</div>
              <div class="card-soft p-3" style="box-shadow:none;">
                <div class="d-flex align-items-center justify-content-between">
                  <div>
                    <div class="fw-semibold">Etapa</div>
                    <div class="text-muted small" id="stepLabel">${escapeHtml(x.processamento?.etapa || "—")}</div>
                  </div>
                  <div class="fw-bold" style="font-size:1.15rem;color:var(--lt-primary);" id="pctLabel">${pct}%</div>
                </div>
                <div class="progress mt-2">
                  <div class="progress-bar" id="pctBar" style="width:${pct}%"></div>
                </div>

                <hr class="my-3" style="border-color: rgba(16,82,144,.14);">

                <div class="d-flex align-items-start gap-2">
                  <i class="bi bi-list-check mt-1"></i>
                  <div class="flex-grow-1">
                    <div class="fw-semibold">Logs</div>
                    <div class="mt-2" id="logBox">${logHtml}</div>
                  </div>
                </div>

                <hr class="my-3" style="border-color: rgba(16,82,144,.14);">

                ${actions}

                <div class="text-muted small mt-3">
                  <i class="bi bi-info-circle me-1"></i>
                  Produto real: IMAP/Watcher → fila → storage → parser → candidato (triagem).
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      // bind actions
      $("#btnSavePreview").addEventListener("click", () => {
        x.previewText = ($("#previewText").value || "").trim();
        saveInbox();
        toast("Preview salvo.");
      });

      $("#btnAutoAssign").addEventListener("click", () => {
        // demo simples: se preview tiver "sql" ou "power" => vaga 1, senão mantém
        const txt = ($("#previewText").value || "").toLowerCase();
        const v = state.vagas[0];
        if(v){
          x.vagaId = v.id;
          saveInbox();
          toast("Vaga atribuída (demo).");
          renderAll();
        }
      });

      $("#btnProcess").addEventListener("click", () => runProcess(x, false));
      $("#btnReprocess").addEventListener("click", () => runProcess(x, true));

      $("#btnCreateCandidate").addEventListener("click", () => {
        createCandidateFromInbox(x);
      });

      $("#btnDiscard").addEventListener("click", () => {
        if(!confirm("Descartar este item?")) return;
        x.status = "descartado";
        x.processamento.etapa = "Descartado";
        x.processamento.pct = 100;
        x.processamento.log = (x.processamento.log||[]);
        x.processamento.log.push("Item descartado manualmente.");
        saveInbox();
        toast("Item descartado.");
        renderAll();
      });
    }

    // ========= Processing simulation
    let simTimer = null;

    function runProcess(item, force){
      if(!item) return;

      if(force){
        item.status = "novo";
        item.processamento = { pct: 0, etapa: "Aguardando", log: [], tentativas: (item.processamento?.tentativas||0), ultimoErro: null };
      }

      if(item.status === "processado"){
        toast("Já está processado. Use Reprocessar se precisar.");
        return;
      }
      if(item.status === "descartado"){
        toast("Item descartado. Não é possível processar.");
        return;
      }

      item.status = "processando";
      item.processamento = item.processamento || { pct: 0, etapa: "Aguardando", log: [], tentativas: 0, ultimoErro: null };
      item.processamento.tentativas = (item.processamento.tentativas||0) + 1;
      item.processamento.ultimoErro = null;
      item.processamento.log = item.processamento.log || [];
      item.processamento.log.push("Processamento iniciado.");

      saveInbox();
      renderAll();

      // simula etapas
      const steps = [
        { pct: 15, etapa: "Validando anexos", log: "Anexos validados." },
        { pct: 35, etapa: "Armazenando arquivo", log: "Arquivo armazenado (demo)." },
        { pct: 60, etapa: "Extraindo texto", log: "Texto extraído (demo)." },
        { pct: 85, etapa: "Normalizando conteúdo", log: "Normalização concluída." },
        { pct: 100, etapa: "Concluído", log: "Processamento finalizado." }
      ];

      let idx = 0;
      clearInterval(simTimer);
      simTimer = setInterval(() => {
        const s = steps[idx++];
        if(!s){
          clearInterval(simTimer);

          // chance de falha (se tiver "senha" no assunto ou item já falhou)
          const fail = (item.assunto||"").toLowerCase().includes("senha") || (item.remetente||"").includes("carlos");
          if(fail && item.processamento.tentativas < 3){
            item.status = "falha";
            item.processamento.etapa = "Falha";
            item.processamento.pct = 100;
            item.processamento.ultimoErro = "Falha na extração: documento protegido / inválido (demo).";
            item.processamento.log.push("Falha detectada: arquivo protegido/ inválido.");
            saveInbox();
            toast("Falha ao processar (demo).");
            renderAll();
            return;
          }

          item.status = "processado";
          item.processamento.etapa = "Concluído";
          item.processamento.pct = 100;

          // preenche preview se vazio
          if(!item.previewText){
            item.previewText = "Resumo (demo): experiência com excel, dashboards, comunicação e relatórios.";
          }

          saveInbox();
          toast("Processamento concluído.");
          renderAll();
          return;
        }

        item.processamento.etapa = s.etapa;
        item.processamento.pct = s.pct;
        item.processamento.log.push(s.log);
        saveInbox();
        renderAll();
      }, 700);
    }

    // ========= Candidate creation (demo)
    function createCandidateFromInbox(item){
      if(!item) return;

      const candRaw = loadJson(CANDS_KEY, { candidatos: [], selectedId: null });
      const candidatos = candRaw.candidatos || [];

      // tenta inferir nome pelo arquivo
      const firstAtt = item.anexos?.[0]?.nome || "Candidato";
      const base = firstAtt.replace(/\.(pdf|doc|docx|txt)$/i,"").replaceAll("_"," ").replaceAll("-"," ");
      const nome = base.length >= 4 ? base : "Novo Candidato";

      const novo = {
        id: uid(),
        nome,
        email: (item.remetente && item.remetente.includes("@")) ? item.remetente : "",
        fone: "",
        cidade: "",
        uf: "",
        fonte: item.origem === "email" ? "Email" : (item.origem === "pasta" ? "Pasta" : "Upload"),
        status: "triagem",
        vagaId: item.vagaId || null,
        obs: "Criado a partir da Entrada (demo).",
        cvText: (item.previewText || "").trim(),
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        lastMatch: null
      };

      candidatos.unshift(novo);
      localStorage.setItem(CANDS_KEY, JSON.stringify({ ...candRaw, candidatos, selectedId: novo.id }));
      state.candidatos = candidatos;

      // marca item como processado e vinculado
      if(item.status !== "processado"){
        item.status = "processado";
        item.processamento = item.processamento || { pct: 100, etapa: "Concluído", log: [], tentativas: 1, ultimoErro: null };
        item.processamento.pct = 100;
        item.processamento.etapa = "Concluído";
        item.processamento.ultimoErro = null;
      }
      item.processamento.log = item.processamento.log || [];
      item.processamento.log.push("Candidato criado a partir da entrada (demo).");
      saveInbox();

      toast("Candidato criado (demo).");
      renderAll();
    }

    // ========= Upload handlers (demo)
    function addUploads(files){
      if(!files || !files.length) return;

      const vagaId = state.vagas[0]?.id || null;

      for(const f of files){
        const name = f.name || "arquivo";
        const ext = (name.split(".").pop() || "").toLowerCase();
        const tipo = ["pdf","doc","docx","txt"].includes(ext) ? ext : "file";

        state.inbox.unshift({
          id: uid(),
          origem: "upload",
          status: "novo",
          recebidoEm: new Date().toISOString(),
          remetente: "upload@local",
          assunto: "Upload manual",
          destinatario: "Portal RH",
          vagaId,
          anexos: [{ nome: name, tipo, tamanhoKB: Math.max(1, Math.round((f.size||1024)/1024)), hash: "up-"+Math.random().toString(16).slice(2,10) }],
          processamento: { pct: 0, etapa: "Aguardando", log: ["Arquivo anexado via upload (demo)."], tentativas: 0, ultimoErro: null },
          previewText: ""
        });
      }

      state.selectedId = state.inbox[0]?.id || state.selectedId;
      saveInbox();
      toast(`${files.length} arquivo(s) adicionado(s) na fila.`);
      renderAll();
    }

    // ========= Import/Export (Entrada)
    function exportJson(){
      const payload = { version:1, exportedAt: new Date().toISOString(), inbox: state.inbox };
      const json = JSON.stringify(payload, null, 2);
      const blob = new Blob([json], { type: "application/json;charset=utf-8" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "entrada_inbox_liotecnica.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      toast("Exportação iniciada.");
    }
    function importJson(){
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json";
      inp.onchange = () => {
        const file = inp.files && inp.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try{
            const data = JSON.parse(reader.result);
            if(data && Array.isArray(data.inbox)){
              state.inbox = data.inbox;
              state.selectedId = state.inbox[0]?.id || null;
              saveInbox();
              toast("Importação concluída.");
              renderAll();
            }else{
              alert("JSON inválido (esperado: { inbox: [...] }).");
            }
          }catch(e){
            console.error(e);
            alert("Falha ao importar JSON.");
          }
        };
        reader.readAsText(file);
      };
      inp.click();
    }

    // ========= Simular coleta (demo)
    function simulateCollect(){
      const vagaId = state.vagas[0]?.id || null;
      const now = Date.now();
      const newItem = {
        id: uid(),
        origem: Math.random() > .45 ? "email" : "pasta",
        status: "novo",
        recebidoEm: new Date(now).toISOString(),
        remetente: Math.random() > .45 ? "novo.candidato@email.com" : "watcher@server",
        assunto: Math.random() > .45 ? "Currículo • Vaga aberta" : "Novo arquivo em pasta monitorada",
        destinatario: Math.random() > .45 ? "rh@liotecnica.com.br" : "FS: \\\\RH\\Curriculos\\Entrada",
        vagaId,
        anexos: [
          { nome: Math.random() > .5 ? "Novo_Candidato_CV.pdf" : "Curriculo_Atualizado.docx", tipo: Math.random() > .5 ? "pdf" : "docx", tamanhoKB: 220 + Math.round(Math.random()*600), hash: "sim-"+Math.random().toString(16).slice(2,10) }
        ],
        processamento: { pct: 0, etapa: "Aguardando", log: ["Item coletado (demo)."], tentativas: 0, ultimoErro: null },
        previewText: ""
      };
      state.inbox.unshift(newItem);
      state.selectedId = newItem.id;
      saveInbox();
      toast("Novo item coletado (demo).");
      renderAll();
    }

    // ========= Wire
    function initLogo(){
      $("#logoDesktop").src = LOGO_DATA_URI;
      $("#logoMobile").src = LOGO_DATA_URI;
    }
    function wireClock(){
      const now = new Date();
      $("#year").textContent = now.getFullYear();
      const tick = () => {
        const d = new Date();
        $("#nowLabel").textContent = d.toLocaleString("pt-BR", { weekday:"short", day:"2-digit", month:"2-digit", hour:"2-digit", minute:"2-digit" });
      };
      tick();
      setInterval(tick, 1000*15);
    }
    function wireFilters(){
      const apply = () => {
        state.filters.q = ($("#fSearch").value || "").trim();
        state.filters.origem = $("#fOrigem").value || "all";
        state.filters.status = $("#fStatus").value || "all";
        renderAll();
      };
      $("#fSearch").addEventListener("input", apply);
      $("#fOrigem").addEventListener("change", apply);
      $("#fStatus").addEventListener("change", apply);
    }
    function wireUpload(){
      const dz = $("#dropzone");
      const picker = $("#filePicker");

      $("#btnAddUpload").addEventListener("click", () => picker.click());
      picker.addEventListener("change", () => addUploads(picker.files));

      dz.addEventListener("dragover", (e) => {
        e.preventDefault();
        dz.classList.add("dragover");
      });
      dz.addEventListener("dragleave", () => dz.classList.remove("dragover"));
      dz.addEventListener("drop", (e) => {
        e.preventDefault();
        dz.classList.remove("dragover");
        const files = e.dataTransfer?.files;
        addUploads(files);
      });
    }
    function wireTopButtons(){
      $("#btnExport").addEventListener("click", exportJson);
      $("#btnImport").addEventListener("click", importJson);
      $("#btnRunSim").addEventListener("click", simulateCollect);

      $("#btnSeedReset").addEventListener("click", () => {
        const ok = confirm("Restaurar demo? Isso substituirá Inbox (Entrada) e resetará as seeds.");
        if(!ok) return;

        localStorage.removeItem(INBOX_KEY);
        localStorage.removeItem(VAGAS_KEY);
        localStorage.removeItem(CANDS_KEY);

        seedIfEmpty();
        loadAll();
        renderAll();
        toast("Demo restaurada.");
      });
    }

    // ========= Init
    (function init(){
      initLogo();
      wireClock();

      seedIfEmpty();
      loadAll();

      wireFilters();
      wireUpload();
      wireTopButtons();

      // select first visible item if none
      if(!state.selectedId && state.inbox[0]) state.selectedId = state.inbox[0].id;
      saveInbox();

      renderAll();
    })();
  </script>
</body>
</html>
